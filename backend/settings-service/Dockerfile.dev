FROM rust:1.90-bookworm

WORKDIR /workspace

# Install build dependencies and cargo-watch
RUN apt-get update && apt-get install -y \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/* \
    && cargo install cargo-watch

# Copy workspace files
COPY Cargo.toml Cargo.lock ./
COPY auth-service/Cargo.toml auth-service/
COPY email-service/Cargo.toml email-service/
COPY settings-service/Cargo.toml settings-service/
COPY shared-types shared-types/
COPY proto/ proto/

# Create dummy source files for dependency caching
RUN mkdir -p auth-service/src email-service/src settings-service/src \
    && echo "fn main() {}" > auth-service/src/main.rs \
    && echo "fn main() {}" > email-service/src/main.rs \
    && echo "fn main() {}" > settings-service/src/main.rs

# Build dependencies
RUN cargo build --package settings-service

# Remove dummy files
RUN rm -rf settings-service/src

# Copy build script if exists
COPY settings-service/build.rs settings-service/ 2>/dev/null || true

# Set the working directory to the service
WORKDIR /workspace

# Use cargo-watch to rebuild on changes
CMD ["cargo", "watch", "-w", "settings-service/src", "-w", "shared-types/src", "-w", "proto", "-x", "run --package settings-service"]
